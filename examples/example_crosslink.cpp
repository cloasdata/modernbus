// A minimum example showing how to use the cross link class
#include <Arduino.h>
#include <modernbus_client.h>
#include <modernbus_crosslink.h>
#include <modernbus_server.h>

CrossLinkManager manager{};
CrossLinkStream clientStream{manager.first};
CrossLinkProvider clientProvider{clientStream};
CrossLinkStream serverStream{manager.second};
CrossLinkProvider serverProvider{serverStream};
Scheduler scheduler{};


ModbusClient<CrossLinkProvider> client{&scheduler, &clientProvider};
ModbusServer<CrossLinkProvider> server{&scheduler, &serverProvider, 0x01};

uint8_t readRequest[]{0x01, 0x04, 0x00, 0x01, 0x00, 0x28, 0xA1, 0xD4};
uint8_t Payload04[] {0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x3e,0x3f,0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4a,0x4b,0x4c,0x4d,0x4e,0x4f};

void setup(){
    Serial.begin(9600);
    client.poll(readRequest, sizeof(readRequest), [](ServerResponse * response){
        Serial.print("Got Response\n");
    });
    server.responseTo(0x04, 0x00).with(Payload04, sizeof(Payload04), 2);

    server.start();
    client.start();

}

void loop(){
    scheduler.execute();
}